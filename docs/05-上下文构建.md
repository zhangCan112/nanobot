# ä¸Šä¸‹æ–‡æ„å»ºè¯¦è§£

## ğŸ“‹ æ–‡ä»¶æ¦‚è¿°

`nanobot/agent/context.py` è´Ÿè´£ä¸º Agent æ„å»ºå®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰ï¼ŒåŒ…æ‹¬èº«ä»½ä¿¡æ¯ã€å¼•å¯¼æ–‡ä»¶ã€è®°å¿†ã€æŠ€èƒ½å’Œä¼šè¯å†å²ã€‚

## ğŸ¯ æ ¸å¿ƒèŒè´£

ContextBuilder è´Ÿè´£ï¼š
1. æ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰
2. åŠ è½½å¹¶æ•´åˆå¼•å¯¼æ–‡ä»¶ï¼ˆAGENTS.md, SOUL.md, USER.md ç­‰ï¼‰
3. åŠ è½½é•¿æœŸè®°å¿†å’Œæ—¥å¸¸ç¬”è®°
4. åŠ è½½æŠ€èƒ½ï¼ˆåˆ†ä¸ºå§‹ç»ˆåŠ è½½å’ŒæŒ‰éœ€åŠ è½½ï¼‰
5. æ„å»º LLM è°ƒç”¨çš„å®Œæ•´æ¶ˆæ¯åˆ—è¡¨
6. æ”¯æŒå›¾åƒé™„ä»¶çš„ base64 ç¼–ç 

## ğŸ—ï¸ ç±»ç»“æ„

```python
class ContextBuilder:
    """
    Builds the context (system prompt + messages) for the agent.
    
    Assembles bootstrap files, memory, skills, and conversation history
    into a coherent prompt for the LLM.
    """
    
    BOOTSTRAP_FILES = [
        "AGENTS.md",    # Agent æŒ‡ä»¤
        "SOUL.md",      # ä¸ªæ€§å®šä¹‰
        "USER.md",       # ç”¨æˆ·ä¿¡æ¯
        "TOOLS.md",      # å·¥å…·è¯´æ˜
        "IDENTITY.md"    # èº«ä»½æ ‡è¯†
    ]
```

## ğŸ“ æ ¸å¿ƒæ–¹æ³•

### 1. build_system_prompt() - æ„å»ºç³»ç»Ÿæç¤ºè¯

```python
def build_system_prompt(self, skill_names: list[str] | None = None) -> str:
    """
    Build the system prompt from bootstrap files, memory, and skills.
    
    Args:
        skill_names: Optional list of skills to include.
    
    Returns:
        Complete system prompt.
    """
```

**æ„å»ºé¡ºåºï¼š**

```
1. æ ¸å¿ƒèº«ä»½ (_get_identity)
   â”œâ”€ å½“å‰æ—¶é—´
   â”œâ”€ è¿è¡Œç¯å¢ƒä¿¡æ¯
   â””â”€ å·¥ä½œç©ºé—´è·¯å¾„

2. å¼•å¯¼æ–‡ä»¶ (_load_bootstrap_files)
   â”œâ”€ AGENTS.md
   â”œâ”€ SOUL.md
   â”œâ”€ USER.md
   â”œâ”€ TOOLS.md
   â””â”€ IDENTITY.md

3. è®°å¿†ä¸Šä¸‹æ–‡ (memory.get_memory_context)
   â”œâ”€ é•¿æœŸè®°å¿† (MEMORY.md)
   â””â”€ ä»Šæ—¥ç¬”è®° (YYYY-MM-DD.md)

4. å§‹ç»ˆåŠ è½½çš„æŠ€èƒ½
   â””â”€ å®Œæ•´å†…å®¹åŠ è½½åˆ°æç¤ºè¯

5. å¯ç”¨æŠ€èƒ½æ‘˜è¦
   â””â”€ ä»…æ˜¾ç¤ºæŠ€èƒ½åˆ—è¡¨ï¼ŒAgent ä½¿ç”¨ read_file æŒ‰éœ€åŠ è½½
```

**è¿”å›æ ¼å¼ï¼š**
```markdown
# nanobot ğŸˆ

You are nanobot, a helpful AI assistant...

## Current Time
2026-02-08 08:59 (Saturday)

## Runtime
macOS arm64, Python 3.11.0

## Workspace
Your workspace is at: /Users/user/.nanobot/workspace
- Memory files: /Users/user/.nanobot/workspace/memory/MEMORY.md
...

---

## AGENTS.md

You are a helpful AI assistant...

---

## SOUL.md

I am nanobot...

---

## USER.md

Information about the user...

---

# Memory

## Long-term Memory
(é‡è¦äº‹å®å’Œåå¥½)

## Today's Notes
(ä»Šæ—¥ç¬”è®°)

---

# Active Skills

## weather
Weather forecast skill...

---

# Skills

The following skills extend your capabilities. To use a skill, read its SKILL.md file using the read_file tool.

## github
- available: true
- description: GitHub operations...

## weather
- available: false (need to install dependencies)
```

### 2. _get_identity() - è·å–æ ¸å¿ƒèº«ä»½

```python
def _get_identity(self) -> str:
    """Get the core identity section."""
    from datetime import datetime
    now = datetime.now().strftime("%Y-%m-%d %H:%M (%A)")
    workspace_path = str(self.workspace.expanduser().resolve())
    system = platform.system()
    runtime = f"{'macOS' if system == 'Darwin' else system} {platform.machine()}, Python {platform.python_version()}"
    
    return f"""# nanobot ğŸˆ

You are nanobot, a helpful AI assistant. You have access to tools that allow you to:
- Read, write, and edit files
- Execute shell commands
- Search the web and fetch web pages
- Send messages to users on chat channels
- Spawn subagents for complex background tasks

## Current Time
{now}

## Runtime
{runtime}

## Workspace
Your workspace is at: {workspace_path}
- Memory files: {workspace_path}/memory/MEMORY.md
- Daily notes: {workspace_path}/memory/YYYY-MM-DD.md
- Custom skills: {workspace_path}/skills/{{skill-name}}/SKILL.md

IMPORTANT: When responding to direct questions or conversations, reply directly with your text response.
Only use the 'message' tool when you need to send a message to a specific chat channel (like WhatsApp).
For normal conversation, just respond with text - do not call the message tool.

Always be helpful, accurate, and concise. When using tools, explain what you're doing.
When remembering something, write to {workspace_path}/memory/MEMORY.md"""
```

**åŒ…å«ä¿¡æ¯ï¼š**
- AI åŠ©æ‰‹èº«ä»½å’Œèƒ½åŠ›æè¿°
- å½“å‰æ—¶é—´å’Œæ—¥æœŸ
- è¿è¡Œç¯å¢ƒï¼ˆæ“ä½œç³»ç»Ÿã€æ¶æ„ã€Python ç‰ˆæœ¬ï¼‰
- å·¥ä½œç©ºé—´è·¯å¾„
- é‡è¦æç¤ºï¼ˆä½•æ—¶ä½¿ç”¨ message å·¥å…·ï¼‰

### 3. _load_bootstrap_files() - åŠ è½½å¼•å¯¼æ–‡ä»¶

```python
def _load_bootstrap_files(self) -> str:
    """Load all bootstrap files from workspace."""
    parts = []
    
    for filename in self.BOOTSTRAP_FILES:
        file_path = self.workspace / filename
        if file_path.exists():
            content = file_path.read_text(encoding="utf-8")
            parts.append(f"## {filename}\n\n{content}")
    
    return "\n\n".join(parts) if parts else ""
```

**å¼•å¯¼æ–‡ä»¶è¯´æ˜ï¼š**

#### AGENTS.md
å®šä¹‰ Agent çš„è¡Œä¸ºå‡†åˆ™å’ŒæŒ‡å¯¼åŸåˆ™ï¼š
```markdown
# Agent Instructions

You are a helpful AI assistant. Be concise, accurate, and friendly.

## Guidelines
- Always explain what you're doing before taking actions
- Ask for clarification when the request is ambiguous
- Use tools to help accomplish tasks
- Remember important information in your memory files
```

#### SOUL.md
å®šä¹‰ Agent çš„ä¸ªæ€§å’Œä»·å€¼è§‚ï¼š
```markdown
# Soul

I am nanobot, a lightweight AI assistant.

## Personality
- Helpful and friendly
- Concise and to the point
- Curious and eager to learn

## Values
- Accuracy over speed
- User privacy and safety
- Transparency in actions
```

#### USER.md
å­˜å‚¨ç”¨æˆ·ç›¸å…³ä¿¡æ¯ï¼š
```markdown
# User

Information about the user goes here.

## Preferences
- Communication style: casual
- Timezone: UTC+8
- Language: Chinese
```

#### TOOLS.md
å·¥å…·ä½¿ç”¨è¯´æ˜ï¼ˆå¯é€‰ï¼‰

#### IDENTITY.md
é¢å¤–èº«ä»½ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

### 4. build_messages() - æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨

```python
def build_messages(
    self,
    history: list[dict[str, Any]],      # ä¼šè¯å†å²
    current_message: str,                # å½“å‰ç”¨æˆ·æ¶ˆæ¯
    skill_names: list[str] | None = None,  # å¯é€‰æŠ€èƒ½åˆ—è¡¨
    media: list[str] | None = None,     # åª’ä½“æ–‡ä»¶è·¯å¾„
    channel: str | None = None,          # æ¸ é“åç§°
    chat_id: str | None = None,          # èŠå¤© ID
) -> list[dict[str, Any]]:
    """
    Build the complete message list for an LLM call.
    
    Returns:
        List of messages including system prompt.
    """
    messages = []

    # 1. ç³»ç»Ÿæç¤ºè¯
    system_prompt = self.build_system_prompt(skill_names)
    if channel and chat_id:
        system_prompt += f"\n\n## Current Session\nChannel: {channel}\nChat ID: {chat_id}"
    messages.append({"role": "system", "content": system_prompt})

    # 2. å†å²è®°å½•
    messages.extend(history)

    # 3. å½“å‰æ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…å«å›¾ç‰‡ï¼‰
    user_content = self._build_user_content(current_message, media)
    messages.append({"role": "user", "content": user_content})

    return messages
```

**æ¶ˆæ¯ç»“æ„ï¼š**
```python
[
    {
        "role": "system",
        "content": "å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯..."
    },
    {
        "role": "user",
        "content": "ä¹‹å‰çš„ç”¨æˆ·æ¶ˆæ¯1"
    },
    {
        "role": "assistant",
        "content": "AI çš„å›å¤1"
    },
    {
        "role": "user",
        "content": "ä¹‹å‰çš„ç”¨æˆ·æ¶ˆæ¯2"
    },
    {
        "role": "assistant",
        "content": [
            {
                "type": "text",
                "text": "AI çš„å›å¤2"
            },
            {
                "type": "image_url",
                "image_url": {
                    "url": "data:image/jpeg;base64,..."
                }
            }
        ]
    },
    {
        "role": "user",
        "content": "å½“å‰ç”¨æˆ·æ¶ˆæ¯"  # å¯èƒ½åŒ…å«å›¾ç‰‡
    }
]
```

### 5. _build_user_content() - æ„å»ºç”¨æˆ·æ¶ˆæ¯å†…å®¹

```python
def _build_user_content(self, text: str, media: list[str] | None) -> str | list[dict[str, Any]]:
    """Build user message content with optional base64-encoded images."""
    if not media:
        return text
    
    images = []
    for path in media:
        p = Path(path)
        mime, _ = mimetypes.guess_type(path)
        if not p.is_file() or not mime or not mime.startswith("image/"):
            continue
        b64 = base64.b64encode(p.read_bytes()).decode()
        images.append({
            "type": "image_url",
            "image_url": {
                "url": f"data:{mime};base64,{b64}"
            }
        })
    
    if not images:
        return text
    return images + [{"type": "text", "text": text}]
```

**æ”¯æŒçš„å†…å®¹æ ¼å¼ï¼š**

#### çº¯æ–‡æœ¬
```python
"What is 2+2?"
```

#### æ–‡æœ¬ + å›¾ç‰‡
```python
[
    {
        "type": "image_url",
        "image_url": {
            "url": "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
        }
    },
    {
        "type": "text",
        "text": "Describe this image"
    }
]
```

### 6. add_tool_result() - æ·»åŠ å·¥å…·ç»“æœ

```python
def add_tool_result(
    self,
    messages: list[dict[str, Any]],
    tool_call_id: str,
    tool_name: str,
    result: str
) -> list[dict[str, Any]]:
    """
    Add a tool result to the message list.
    
    Args:
        messages: Current message list.
        tool_call_id: ID of the tool call.
        tool_name: Name of the tool.
        result: Tool execution result.
    
    Returns:
        Updated message list.
    """
    messages.append({
        "role": "tool",
        "tool_call_id": tool_call_id,
        "name": tool_name,
        "content": result
    })
    return messages
```

**æ¶ˆæ¯æ ¼å¼ï¼š**
```python
{
    "role": "tool",
    "tool_call_id": "call_123",
    "name": "read_file",
    "content": "# README.md\n\nThis is a project..."
}
```

### 7. add_assistant_message() - æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯

```python
def add_assistant_message(
    self,
    messages: list[dict[str, Any]],
    content: str | None,
    tool_calls: list[dict[str, Any]] | None = None
) -> list[dict[str, Any]]:
    """
    Add an assistant message to the message list.
    
    Args:
        messages: Current message list.
        content: Message content.
        tool_calls: Optional tool calls.
    
    Returns:
        Updated message list.
    """
    msg: dict[str, Any] = {
        "role": "assistant",
        "content": content or ""
    }
    
    if tool_calls:
        msg["tool_calls"] = tool_calls
    
    messages.append(msg)
    return messages
```

**æ¶ˆæ¯æ ¼å¼ï¼š**

#### çº¯æ–‡æœ¬å“åº”
```python
{
    "role": "assistant",
    "content": "The file contains project documentation."
}
```

#### å·¥å…·è°ƒç”¨å“åº”
```python
{
    "role": "assistant",
    "content": None,
    "tool_calls": [
        {
            "id": "call_123",
            "type": "function",
            "function": {
                "name": "read_file",
                "arguments": "{\"path\": \"README.md\"}"
            }
        }
    ]
}
```

## ğŸ¨ æŠ€èƒ½åŠ è½½ç­–ç•¥

### å§‹ç»ˆåŠ è½½çš„æŠ€èƒ½

æŸäº›æŠ€èƒ½è¢«æ ‡è®°ä¸º"å§‹ç»ˆåŠ è½½"ï¼Œå…¶å®Œæ•´å†…å®¹ä¼šç›´æ¥åŒ…å«åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­ï¼š

```python
always_skills = self.skills.get_always_skills()
if always_skills:
    always_content = self.skills.load_skills_for_context(always_skills)
    if always_content:
        parts.append(f"# Active Skills\n\n{always_content}")
```

**é€‚ç”¨åœºæ™¯ï¼š**
- ä½¿ç”¨é¢‘ç‡æé«˜çš„æ ¸å¿ƒæŠ€èƒ½
- å†…å®¹è¾ƒçŸ­çš„æŠ€èƒ½ï¼ˆé¿å…æç¤ºè¯è¿‡é•¿ï¼‰

### æŒ‰éœ€åŠ è½½çš„æŠ€èƒ½

å¤§å¤šæ•°æŠ€èƒ½ä»…æ˜¾ç¤ºæ‘˜è¦ï¼ŒAgent éœ€è¦æ—¶ä½¿ç”¨ `read_file` å·¥å…·è¯»å–ï¼š

```python
skills_summary = self.skills.build_skills_summary()
if skills_summary:
    parts.append(f"""# Skills

The following skills extend your capabilities. To use a skill, read its SKILL.md file using the read_file tool.
Skills with available="false" need dependencies installed first - you can try installing them with apt/brew.

{skills_summary}""")
```

**æ‘˜è¦æ ¼å¼ï¼š**
```markdown
## github
- available: true
- description: GitHub operations (create repos, issues, PRs)

## weather
- available: false
- description: Weather forecast and conditions
- dependencies: Need to install weather API dependencies

## tmux
- available: true
- description: Tmux session management
```

## ğŸ“Š å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•å¯¹è¯

```python
# ç”¨æˆ·: "Hello!"

messages = context.build_messages(
    history=[],
    current_message="Hello!",
    media=None,
    channel="cli",
    chat_id="direct"
)

# ç»“æœ:
[
    {
        "role": "system",
        "content": """# nanobot ğŸˆ

You are nanobot, a helpful AI assistant...
(å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯)"""
    },
    {
        "role": "user",
        "content": "Hello!"
    }
]
```

### ç¤ºä¾‹ 2: å¸¦å†å²è®°å½•çš„å¯¹è¯

```python
# ç”¨æˆ·: "What did we talk about earlier?"

history = [
    {"role": "user", "content": "I like Python"},
    {"role": "assistant", "content": "Great! Python is a versatile language."}
]

messages = context.build_messages(
    history=history,
    current_message="What did we talk about earlier?",
    media=None,
    channel="telegram",
    chat_id="123456"
)

# ç»“æœ:
[
    {
        "role": "system",
        "content": """... (ç³»ç»Ÿæç¤ºè¯)
        
## Current Session
Channel: telegram
Chat ID: 123456"""
    },
    {"role": "user", "content": "I like Python"},
    {"role": "assistant", "content": "Great! Python is a versatile language."},
    {"role": "user", "content": "What did we talk about earlier?"}
]
```

### ç¤ºä¾‹ 3: å¸¦å›¾ç‰‡çš„æ¶ˆæ¯

```python
# ç”¨æˆ·å‘é€å›¾ç‰‡ "photo.jpg" å¹¶é—® "What's this?"

messages = context.build_messages(
    history=[],
    current_message="What's this?",
    media=["/tmp/photo.jpg"],
    channel="telegram",
    chat_id="123456"
)

# ç»“æœ:
[
    {
        "role": "system",
        "content": "... (ç³»ç»Ÿæç¤ºè¯)"
    },
    {
        "role": "user",
        "content": [
            {
                "type": "image_url",
                "image_url": {
                    "url": "data:image/jpeg;base64,/9j/4AAQ..."
                }
            },
            {
                "type": "text",
                "text": "What's this?"
            }
        ]
    }
]
```

### ç¤ºä¾‹ 4: å·¥å…·è°ƒç”¨åçš„æ¶ˆæ¯æ›´æ–°

```python
# åˆå§‹æ¶ˆæ¯
messages = [
    {"role": "system", "content": "..."},
    {"role": "user", "content": "Read README.md"}
]

# LLM è¿”å›å·¥å…·è°ƒç”¨
tool_call = {
    "id": "call_123",
    "type": "function",
    "function": {
        "name": "read_file",
        "arguments": "{\"path\": \"README.md\"}"
    }
}

# æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
messages = context.add_assistant_message(messages, None, [tool_call])

# æ‰§è¡Œå·¥å…·
result = await tools.execute("read_file", {"path": "README.md"})

# æ·»åŠ å·¥å…·ç»“æœ
messages = context.add_tool_result(
    messages,
    tool_call_id="call_123",
    tool_name="read_file",
    result="# nanobot\n\nThis is a project..."
)

# æœ€ç»ˆæ¶ˆæ¯åˆ—è¡¨
[
    {"role": "system", "content": "..."},
    {"role": "user", "content": "Read README.md"},
    {"role": "assistant", "content": None, "tool_calls": [tool_call]},
    {"role": "tool", "tool_call_id": "call_123", "name": "read_file", "content": "# nanobot\n\nThis is a project..."}
]
```

## ğŸ”§ ä¼˜åŒ–æŠ€å·§

### 1. æ§åˆ¶æç¤ºè¯é•¿åº¦

```markdown
## AGENTS.md
ä¿æŒç®€æ´ï¼Œé¿å…å†—é•¿çš„æŒ‡ä»¤ã€‚

## SOUL.md
åªåŒ…å«å…³é”®ä¸ªæ€§ç‰¹å¾ã€‚

## USER.md
åªè®°å½•é‡è¦çš„åå¥½ä¿¡æ¯ã€‚
```

### 2. åˆç†ä½¿ç”¨å§‹ç»ˆåŠ è½½æŠ€èƒ½

- âœ… **é€‚åˆå§‹ç»ˆåŠ è½½**: ç®€çŸ­ã€é«˜é¢‘ä½¿ç”¨çš„æ ¸å¿ƒæŠ€èƒ½
- âŒ **ä¸é€‚åˆå§‹ç»ˆåŠ è½½**: é•¿æ–‡æ¡£ã€ä½é¢‘ä½¿ç”¨çš„ä¸“ä¸šæŠ€èƒ½

### 3. åˆ©ç”¨è®°å¿†ç³»ç»Ÿ

```markdown
## Long-term Memory (MEMORY.md)
å­˜å‚¨æŒä¹…åŒ–çš„é‡è¦ä¿¡æ¯ï¼š
- ç”¨æˆ·åå¥½
- é¡¹ç›®ç‰¹å®šçŸ¥è¯†
- å¸¸ç”¨å‘½ä»¤å’Œæ¨¡å¼

## Today's Notes (YYYY-MM-DD.md)
å­˜å‚¨ä¸´æ—¶ä¿¡æ¯ï¼š
- ä»Šæ—¥ä»»åŠ¡
- ä¸´æ—¶ä¸Šä¸‹æ–‡
- å³å°†è¢«é—å¿˜çš„ä¿¡æ¯
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01-é¡¹ç›®æ¦‚è¿°.md](./01-é¡¹ç›®æ¦‚è¿°.md) - é¡¹ç›®æ•´ä½“ä»‹ç»
- [04-Agentæ ¸å¿ƒ.md](./04-Agentæ ¸å¿ƒ.md) - Agent æ ¸å¿ƒé€»è¾‘
- [06-è®°å¿†ç³»ç»Ÿ.md](./06-è®°å¿†ç³»ç»Ÿ.md) - è®°å¿†ç³»ç»Ÿè¯¦è§£
- [07-å·¥å…·ç³»ç»Ÿ.md](./07-å·¥å…·ç³»ç»Ÿ.md) - å·¥å…·ç³»ç»Ÿè¯¦è§£