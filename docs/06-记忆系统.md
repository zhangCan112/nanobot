# è®°å¿†ç³»ç»Ÿè¯¦è§£

## ğŸ“‹ æ–‡ä»¶æ¦‚è¿°

`nanobot/agent/memory.py` å®ç°äº† nanobot çš„è®°å¿†ç³»ç»Ÿï¼Œæ”¯æŒé•¿æœŸè®°å¿†å’ŒçŸ­æœŸæ—¥å¸¸ç¬”è®°çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

MemoryStore æä¾›ä¸¤ç§ç±»å‹çš„è®°å¿†ï¼š
1. **é•¿æœŸè®°å¿† (MEMORY.md)**: æŒä¹…åŒ–çš„é‡è¦ä¿¡æ¯
2. **æ—¥å¸¸ç¬”è®° (YYYY-MM-DD.md)**: æŒ‰æ—¥æœŸè®°å½•çš„çŸ­æœŸç¬”è®°

## ğŸ—ï¸ ç±»ç»“æ„

```python
class MemoryStore:
    """
    Memory system for the agent.
    
    Supports daily notes (memory/YYYY-MM-DD.md) and long-term memory (MEMORY.md).
    """
    
    def __init__(self, workspace: Path):
        self.workspace = workspace
        self.memory_dir = ensure_dir(workspace / "memory")
        self.memory_file = self.memory_dir / "MEMORY.md"
```

**ç›®å½•ç»“æ„ï¼š**
```
~/.nanobot/workspace/
â””â”€â”€ memory/
    â”œâ”€â”€ MEMORY.md           # é•¿æœŸè®°å¿†
    â”œâ”€â”€ 2026-02-08.md     # 2026å¹´2æœˆ8æ—¥çš„ç¬”è®°
    â”œâ”€â”€ 2026-02-07.md     # 2026å¹´2æœˆ7æ—¥çš„ç¬”è®°
    â””â”€â”€ ...
```

## ğŸ“ æ ¸å¿ƒæ–¹æ³•

### 1. get_today_file() - è·å–ä»Šæ—¥ç¬”è®°è·¯å¾„

```python
def get_today_file(self) -> Path:
    """Get path to today's memory file."""
    return self.memory_dir / f"{today_date()}.md"
```

**ç¤ºä¾‹ï¼š**
```python
# å¦‚æœä»Šå¤©æ˜¯ 2026-02-08
memory.get_today_file()
# è¿”å›: Path("~/.nanobot/workspace/memory/2026-02-08.md")
```

### 2. read_today() - è¯»å–ä»Šæ—¥ç¬”è®°

```python
def read_today(self) -> str:
    """Read today's memory notes."""
    today_file = self.get_today_file()
    if today_file.exists():
        return today_file.read_text(encoding="utf-8")
    return ""
```

**è¿”å›å€¼ï¼š**
- æ–‡ä»¶å­˜åœ¨: è¿”å›æ–‡ä»¶å†…å®¹
- æ–‡ä»¶ä¸å­˜åœ¨: è¿”å›ç©ºå­—ç¬¦ä¸²

### 3. append_today() - è¿½åŠ ä»Šæ—¥ç¬”è®°

```python
def append_today(self, content: str) -> None:
    """Append content to today's memory notes."""
    today_file = self.get_today_file()
    
    if today_file.exists():
        existing = today_file.read_text(encoding="utf-8")
        content = existing + "\n" + content
    else:
        # æ·»åŠ æ–°æ—¥æœŸçš„æ ‡é¢˜
        header = f"# {today_date()}\n\n"
        content = header + content
    
    today_file.write_text(content, encoding="utf-8")
```

**è¡Œä¸ºï¼š**
- æ–‡ä»¶ä¸å­˜åœ¨: åˆ›å»ºæ–°æ–‡ä»¶å¹¶æ·»åŠ æ—¥æœŸæ ‡é¢˜
- æ–‡ä»¶å­˜åœ¨: è¿½åŠ å†…å®¹åˆ°æ–‡ä»¶æœ«å°¾

**ç¤ºä¾‹ï¼š**
```python
# ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰
memory.append_today("- Task 1 completed")
# æ–‡ä»¶å†…å®¹:
# # 2026-02-08
# 
# - Task 1 completed

# ç¬¬äºŒæ¬¡è°ƒç”¨
memory.append_today("- Task 2 completed")
# æ–‡ä»¶å†…å®¹:
# # 2026-02-08
# 
# - Task 1 completed
# - Task 2 completed
```

### 4. read_long_term() - è¯»å–é•¿æœŸè®°å¿†

```python
def read_long_term(self) -> str:
    """Read long-term memory (MEMORY.md)."""
    if self.memory_file.exists():
        return self.memory_file.read_text(encoding="utf-8")
    return ""
```

**è¿”å›å€¼ï¼š**
- æ–‡ä»¶å­˜åœ¨: è¿”å› MEMORY.md çš„å†…å®¹
- æ–‡ä»¶ä¸å­˜åœ¨: è¿”å›ç©ºå­—ç¬¦ä¸²

### 5. write_long_term() - å†™å…¥é•¿æœŸè®°å¿†

```python
def write_long_term(self, content: str) -> None:
    """Write to long-term memory (MEMORY.md)."""
    self.memory_file.write_text(content, encoding="utf-8")
```

**æ³¨æ„ï¼š** è¿™æ˜¯ä¸€ä¸ªè¦†ç›–æ“ä½œï¼Œä¼šæ›¿æ¢æ•´ä¸ªæ–‡ä»¶å†…å®¹ã€‚

**ä½¿ç”¨å»ºè®®ï¼š**
```python
# æ­£ç¡®åšæ³•ï¼šå…ˆè¯»å–ï¼Œä¿®æ”¹åå†™å…¥
existing = memory.read_long_term()
updated = existing + "\n\n" + new_info
memory.write_long_term(updated)

# é”™è¯¯åšæ³•ï¼šç›´æ¥å†™å…¥ï¼ˆä¼šä¸¢å¤±ä¹‹å‰çš„å†…å®¹ï¼‰
memory.write_long_term(new_info)  # âŒ
```

### 6. get_recent_memories() - è·å–æœ€è¿‘çš„è®°å¿†

```python
def get_recent_memories(self, days: int = 7) -> str:
    """
    Get memories from the last N days.
    
    Args:
        days: Number of days to look back.
    
    Returns:
        Combined memory content.
    """
    from datetime import timedelta
    
    memories = []
    today = datetime.now().date()
    
    for i in range(days):
        date = today - timedelta(days=i)
        date_str = date.strftime("%Y-%m-%d")
        file_path = self.memory_dir / f"{date_str}.md"
        
        if file_path.exists():
            content = file_path.read_text(encoding="utf-8")
            memories.append(content)
    
    return "\n\n---\n\n".join(memories)
```

**ç¤ºä¾‹ï¼š**
```python
# è·å–è¿‡å»7å¤©çš„è®°å¿†
memories = memory.get_recent_memories(days=7)

# è¿”å›æ ¼å¼:
"""
# 2026-02-08

- ä»Šæ—¥ä»»åŠ¡1
- ä»Šæ—¥ä»»åŠ¡2

---

# 2026-02-07

- æ˜¨æ—¥ä»»åŠ¡1
- æ˜¨æ—¥ä»»åŠ¡2

---

# 2026-02-06

- å‰æ—¥ä»»åŠ¡1
"""
```

### 7. list_memory_files() - åˆ—å‡ºæ‰€æœ‰è®°å¿†æ–‡ä»¶

```python
def list_memory_files(self) -> list[Path]:
    """List all memory files sorted by date (newest first)."""
    if not self.memory_dir.exists():
        return []
    
    files = list(self.memory_dir.glob("????-??-??.md"))
    return sorted(files, reverse=True)
```

**è¿”å›ï¼š**
- æŒ‰æ—¥æœŸé™åºæ’åˆ—çš„æ–‡ä»¶åˆ—è¡¨
- æ ¼å¼åŒ¹é…: `YYYY-MM-DD.md`

**ç¤ºä¾‹ï¼š**
```python
files = memory.list_memory_files()
# è¿”å›:
# [
#     Path("memory/2026-02-08.md"),
#     Path("memory/2026-02-07.md"),
#     Path("memory/2026-02-06.md"),
#     ...
# ]
```

### 8. get_memory_context() - è·å–è®°å¿†ä¸Šä¸‹æ–‡

```python
def get_memory_context(self) -> str:
    """
    Get memory context for the agent.
    
    Returns:
        Formatted memory context including long-term and recent memories.
    """
    parts = []
    
    # é•¿æœŸè®°å¿†
    long_term = self.read_long_term()
    if long_term:
        parts.append("## Long-term Memory\n" + long_term)
    
    # ä»Šæ—¥ç¬”è®°
    today = self.read_today()
    if today:
        parts.append("## Today's Notes\n" + today)
    
    return "\n\n".join(parts) if parts else ""
```

**è¿”å›æ ¼å¼ï¼š**
```markdown
## Long-term Memory

(é•¿æœŸè®°å¿†å†…å®¹)

## Today's Notes

# 2026-02-08

(ä»Šæ—¥ç¬”è®°å†…å®¹)
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å­˜å‚¨ç”¨æˆ·åå¥½

```python
# é¦–æ¬¡äº¤äº’
user_preferences = """
## User Preferences

- Language: Chinese
- Timezone: UTC+8
- Preferred response style: Concise
"""

memory.write_long_term(user_preferences)

# åç»­äº¤äº’
memory.read_long_term()
# è¿”å›ç”¨æˆ·åå¥½ä¿¡æ¯
```

### åœºæ™¯ 2: è®°å½•æ—¥å¸¸ä»»åŠ¡

```python
# ä»»åŠ¡å®Œæˆæ—¶è®°å½•
memory.append_today("- [x] Completed project setup")
memory.append_today("- [x] Wrote documentation")

# æŸ¥çœ‹ä»Šæ—¥è¿›åº¦
today_notes = memory.read_today()
print(today_notes)
# è¾“å‡º:
# # 2026-02-08
# 
# - [x] Completed project setup
# - [x] Wrote documentation
```

### åœºæ™¯ 3: æŒä¹…åŒ–é‡è¦ä¿¡æ¯

```python
# ä¿å­˜é‡è¦ä¿¡æ¯
important_info = """
## Project Details

- Name: nanobot
- Version: 0.1.3
- Repository: https://github.com/HKUDS/nanobot
"""

existing = memory.read_long_term()
if existing:
    memory.write_long_term(existing + "\n\n" + important_info)
else:
    memory.write_long_term(important_info)
```

### åœºæ™¯ 4: å›é¡¾æœ€è¿‘æ´»åŠ¨

```python
# è·å–è¿‡å»3å¤©çš„æ´»åŠ¨
recent = memory.get_recent_memories(days=3)

# Agent å¯ä»¥åŸºäºè¿™äº›ä¿¡æ¯ï¼š
# 1. å›é¡¾å·¥ä½œè¿›åº¦
# 2. è¯†åˆ«é‡å¤ä»»åŠ¡
# 3. å‘ç°å¯ä¼˜åŒ–çš„æ¨¡å¼
```

## ğŸ¨ æœ€ä½³å®è·µ

### 1. é•¿æœŸè®°å¿† (MEMORY.md)

**ç”¨é€”ï¼š**
- ç”¨æˆ·åå¥½å’Œä¹ æƒ¯
- é¡¹ç›®å…³é”®ä¿¡æ¯
- é‡è¦è”ç³»äºº
- å¸¸ç”¨å‘½ä»¤å’Œæ¨¡å¼
- ç³»ç»Ÿé…ç½®è®°å½•

**æ ¼å¼ç¤ºä¾‹ï¼š**
```markdown
# Long-term Memory

## User Preferences
- Language: Chinese
- Timezone: UTC+8
- Communication style: Professional but friendly

## Project Information
- Project name: nanobot
- Purpose: Personal AI assistant
- Tech stack: Python, asyncio, LiteLLM

## Important Contacts
- Team lead: John (john@example.com)
- Deployment: ops@company.com

## Common Commands
- Build: `docker build -t nanobot .`
- Run: `docker run -v ~/.nanobot:/root/.nanobot nanobot`
- Test: `pytest tests/`
```

### 2. æ—¥å¸¸ç¬”è®° (YYYY-MM-DD.md)

**ç”¨é€”ï¼š**
- å½“æ—¥ä»»åŠ¡æ¸…å•
- ä¸´æ—¶ç¬”è®°å’Œæƒ³æ³•
- é—®é¢˜è®°å½•
- è¿›åº¦è¿½è¸ª

**æ ¼å¼ç¤ºä¾‹ï¼š**
```markdown
# 2026-02-08

## Tasks
- [x] Review pull requests
- [ ] Update documentation
- [ ] Fix bug #123

## Notes
- User reported issue with WhatsApp login
- Need to investigate bridge service

## Progress
- Completed authentication fix
- Started work on feature X
```

### 3. è®°å¿†ç®¡ç†

**å®šæœŸæ¸…ç†ï¼š**
```python
# åˆ é™¤è¶…è¿‡30å¤©çš„æ—§ç¬”è®°
from datetime import timedelta

files = memory.list_memory_files()
cutoff = datetime.now().date() - timedelta(days=30)

for file in files:
    date_str = file.stem
    date = datetime.strptime(date_str, "%Y-%m-%d").date()
    if date < cutoff:
        # å°†é‡è¦ä¿¡æ¯è½¬ç§»åˆ°é•¿æœŸè®°å¿†ååˆ é™¤
        content = file.read_text()
        # ... å¤„ç†é€»è¾‘
        file.unlink()
```

**ä¿¡æ¯è¿ç§»ï¼š**
```python
# å°†é¢‘ç¹å‡ºç°çš„ä¿¡æ¯è½¬ç§»åˆ°é•¿æœŸè®°å¿†
recent_memories = memory.get_recent_memories(days=14)

# åˆ†ææ¨¡å¼ï¼Œå‘ç°éœ€è¦æŒä¹…åŒ–çš„ä¿¡æ¯
# ä¾‹å¦‚: ç”¨æˆ·æ€»æ˜¯è¦æ±‚åŒæ ·çš„æ“ä½œ

# è¿ç§»åˆ°é•¿æœŸè®°å¿†
long_term = memory.read_long_term()
memory.write_long_term(long_term + "\n\n" + discovered_patterns)
```

## ğŸ”§ è¾…åŠ©å‡½æ•°

### ensure_dir()

```python
from nanobot.utils.helpers import ensure_dir

# ç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
memory_dir = ensure_dir(workspace / "memory")
```

### today_date()

```python
from nanobot.utils.helpers import today_date

# è¿”å›å½“å‰æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼: YYYY-MM-DD
date_str = today_date()
# ç¤ºä¾‹: "2026-02-08"
```

## ğŸ“š åœ¨ Agent ä¸­çš„ä½¿ç”¨

### ä¸Šä¸‹æ–‡æ„å»º

```python
# ContextBuilder ä½¿ç”¨è®°å¿†ç³»ç»Ÿ
from nanobot.agent.memory import MemoryStore

class ContextBuilder:
    def __init__(self, workspace: Path):
        self.memory = MemoryStore(workspace)
    
    def build_system_prompt(self) -> str:
        # è·å–è®°å¿†ä¸Šä¸‹æ–‡
        memory_context = self.memory.get_memory_context()
        
        # åŒ…å«åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­
        return f"""# nanobot ğŸˆ

# Memory
{memory_context}
...
"""
```

### å·¥å…·è°ƒç”¨

Agent å¯ä»¥é€šè¿‡å·¥å…·æ“ä½œè®°å¿†ï¼š

```python
# å†™æ–‡ä»¶å·¥å…·å†™å…¥ MEMORY.md
await tools.execute("write_file", {
    "path": "memory/MEMORY.md",
    "content": "New information to remember"
})

# å†™æ–‡ä»¶å·¥å…·å†™å…¥ä»Šæ—¥ç¬”è®°
today = datetime.now().strftime("%Y-%m-%d")
await tools.execute("write_file", {
    "path": f"memory/{today}.md",
    "content": "- Completed task"
})

# è¯»å–è®°å¿†
await tools.execute("read_file", {
    "path": "memory/MEMORY.md"
})
```

## ğŸŒŸ é«˜çº§ç”¨æ³•

### 1. åˆ†ç±»è®°å¿†

```markdown
# MEMORY.md

## User Profile
- Name: Alice
- Role: Developer
- Skills: Python, JavaScript

## Project Context
- Current project: nanobot
- Phase: Development
- Deadline: 2026-03-01

## Preferences
- Response length: Short and concise
- Code style: PEP 8
- Testing: pytest with high coverage
```

### 2. é“¾æ¥ç›¸å…³ç¬”è®°

```markdown
# 2026-02-08.md

## Tasks
- [x] Design API architecture

## Notes
- See memory/MEMORY.md for user preferences
- Related: 2026-02-07.md (previous discussions)

## Links
- [Project Docs](https://docs.example.com)
- [API Reference](https://api.example.com)
```

### 3. æ™ºèƒ½æ£€ç´¢

```python
def search_memory(keyword: str) -> list[str]:
    """åœ¨è®°å¿†ä¸­æœç´¢å…³é”®è¯"""
    results = []
    
    # æœç´¢é•¿æœŸè®°å¿†
    long_term = memory.read_long_term()
    if keyword.lower() in long_term.lower():
        results.append("MEMORY.md")
    
    # æœç´¢æœ€è¿‘çš„ç¬”è®°
    files = memory.list_memory_files()
    for file in files:
        content = file.read_text(encoding="utf-8")
        if keyword.lower() in content.lower():
            results.append(str(file.name))
    
    return results
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [01-é¡¹ç›®æ¦‚è¿°.md](./01-é¡¹ç›®æ¦‚è¿°.md) - é¡¹ç›®æ•´ä½“ä»‹ç»
- [04-Agentæ ¸å¿ƒ.md](./04-Agentæ ¸å¿ƒ.md) - Agent æ ¸å¿ƒé€»è¾‘
- [05-ä¸Šä¸‹æ–‡æ„å»º.md](./05-ä¸Šä¸‹æ–‡æ„å»º.md) - ä¸Šä¸‹æ–‡æ„å»ºè¯¦è§£
- [07-å·¥å…·ç³»ç»Ÿ.md](./07-å·¥å…·ç³»ç»Ÿ.md) - å·¥å…·ç³»ç»Ÿè¯¦è§£