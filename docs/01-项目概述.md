# nanobot 项目概述

## 📋 项目简介

**nanobot** 是一个超轻量级（~4,000 行核心代码）的个人 AI 助手项目，采用 Python 编写，支持多渠道交互、多 LLM 提供商、工具调用、记忆管理等核心 AI Agent 功能。

## 🎯 核心特性

### 1. 超轻量级
- 核心代码仅约 4,000 行（相比 Clawdbot 的 43 万行减少了 99%）
- 代码结构清晰，易于理解和维护
- 快速启动，低资源消耗

### 2. 多提供商支持
- **LLM 提供商**: OpenRouter、Anthropic (Claude)、OpenAI (GPT)、DeepSeek、Gemini、Groq、Zhipu、DashScope (Qwen)、Moonshot/Kimi、vLLM (本地模型)、AiHubMix
- 统一的 LiteLLM 接口，便于切换不同模型

### 3. 多渠道集成
- **Telegram**: 机器人交互（最简单）
- **WhatsApp**: 个人消息（需要扫码登录）
- **Discord**: 服务器和私信
- **Feishu (飞书)**: 企业级集成（WebSocket 长连接）

### 4. 强大的工具系统
内置工具包括：
- 📁 **文件系统**: 读取、写入、编辑、列出目录
- 💻 **Shell**: 执行系统命令
- 🌐 **Web**: 网络搜索、网页抓取
- 💬 **消息**: 向指定渠道发送消息
- 🤖 **子代理**: 生成后台子任务
- ⏰ **定时任务**: Cron 风格的任务调度

### 5. 智能记忆系统
- **长期记忆**: 持久化存储重要信息（`MEMORY.md`）
- **日常笔记**: 按日期存储的短期记忆（`YYYY-MM-DD.md`）
- **会话管理**: 独立的对话会话

### 6. 定时任务与心跳
- **Cron 服务**: 类似 Linux cron 的任务调度
- **心跳服务**: 定期唤醒 AI 进行主动任务
- 支持周期性任务和一次性任务

## 🏗️ 架构设计

```
nanobot/
├── agent/          # 🧠 核心 Agent 逻辑
│   ├── loop.py     #    Agent 处理循环（LLM ↔ 工具执行）
│   ├── context.py  #    上下文/提示词构建
│   ├── memory.py   #    记忆系统
│   ├── skills.py   #    技能加载器
│   ├── subagent.py #    子代理管理
│   └── tools/      #    工具系统
│       ├── base.py      # 工具基类
│       ├── registry.py  # 工具注册表
│       ├── filesystem.py # 文件工具
│       ├── shell.py      # Shell 工具
│       ├── web.py        # Web 工具
│       ├── message.py    # 消息工具
│       ├── spawn.py      # 子代理工具
│       └── cron.py       # 定时任务工具
├── channels/       # 📱 聊天渠道集成
│   ├── base.py     #    渠道基类
│   ├── manager.py  #    渠道管理器
│   ├── telegram.py #    Telegram 实现
│   ├── whatsapp.py #    WhatsApp 实现
│   ├── discord.py  #    Discord 实现
│   └── feishu.py   #    飞书实现
├── providers/      # 🤖 LLM 提供商
│   ├── base.py             # 提供商基类
│   ├── litellm_provider.py # LiteLLM 实现
│   └── transcription.py    # 语音转录
├── bus/            # 🚌 消息总线
│   ├── events.py   #    事件定义
│   └── queue.py    #    消息队列
├── cron/           # ⏰ 定时任务
│   ├── service.py  #    Cron 服务
│   └── types.py    #    类型定义
├── heartbeat/      # 💓 心跳服务
│   └── service.py  #    心跳实现
├── session/        # 💬 会话管理
│   └── manager.py  #    会话管理器
├── config/         # ⚙️ 配置管理
│   ├── schema.py   #    配置架构
│   └── loader.py   #    配置加载器
├── cli/            # 🖥️ 命令行接口
│   └── commands.py #    CLI 命令定义
├── utils/          # 🔧 工具函数
│   └── helpers.py  #    辅助函数
├── skills/         # 🎯 内置技能
│   ├── github/     #    GitHub 技能
│   ├── weather/    #    天气技能
│   ├── tmux/       #    Tmux 技能
│   ├── cron/       #    Cron 技能
│   ├── summarize/  #    总结技能
│   └── skill-creator/ # 技能创建器
├── bridge/         # 🌉 WhatsApp 桥接服务
│   ├── index.ts    #    TypeScript 入口
│   ├── server.ts   #    WebSocket 服务器
│   ├── whatsapp.ts #    WhatsApp 集成
│   └── types.d.ts  #    类型定义
└── workspace/      # 📂 工作空间（用户数据）
    ├── AGENTS.md   # Agent 指令
    ├── SOUL.md     # 个性定义
    ├── USER.md     # 用户信息
    ├── TOOLS.md    # 工具说明
    ├── HEARTBEAT.md # 心跳提示
    └── memory/     # 记忆文件
        ├── MEMORY.md # 长期记忆
        └── *.md     # 日常笔记
```

## 🔄 核心工作流程

### 1. 消息处理流程

```
用户消息 (Telegram/WhatsApp/Discord/Feishu/CLI)
    ↓
Channel Manager (渠道管理器)
    ↓
Message Bus (消息总线)
    ↓
Agent Loop (Agent 循环)
    ↓
Context Builder (上下文构建)
    ├─ 读取配置
    ├─ 加载记忆 (MEMORY.md, 日常笔记)
    ├─ 加载技能
    └─ 加载会话历史
    ↓
LLM Provider (调用大模型)
    ↓
Tool Execution (工具执行)
    ├─ 文件操作
    ├─ Shell 命令
    ├─ Web 搜索
    ├─ 消息发送
    └─ 子代理生成
    ↓
更新记忆和会话
    ↓
返回响应
    ↓
Channel Manager 发送回复
```

### 2. 启动流程

```bash
nanobot gateway
    ↓
加载配置 (~/.nanobot/config.json)
    ↓
初始化组件
    ├─ MessageBus (消息总线)
    ├─ LLM Provider (LLM 提供商)
    ├─ CronService (定时任务)
    ├─ HeartbeatService (心跳)
    ├─ AgentLoop (Agent 循环)
    └─ ChannelManager (渠道管理器)
    ↓
启动服务
    ├─ CronService.start()
    ├─ HeartbeatService.start()
    ├─ AgentLoop.run()
    └─ ChannelManager.start_all()
```

## 🎮 主要命令

### 初始化
```bash
nanobot onboard          # 初始化配置和工作空间
```

### Agent 交互
```bash
nanobot agent -m "消息"  # 发送单条消息
nanobot agent            # 交互式对话模式
```

### Gateway 服务
```bash
nanobot gateway          # 启动网关（连接所有渠道）
```

### 渠道管理
```bash
nanobot channels status  # 查看渠道状态
nanobot channels login   # 登录 WhatsApp（扫码）
```

### 定时任务
```bash
nanobot cron list        # 列出任务
nanobot cron add --name "daily" --message "早安" --cron "0 9 * * *"
nanobot cron remove <id> # 删除任务
```

### 状态查看
```bash
nanobot status           # 查看系统状态
```

## 🔒 安全特性

### 1. 工作空间限制
```json
{
  "tools": {
    "restrictToWorkspace": true
  }
}
```
- 启用后，所有文件工具和 Shell 工具将限制在工作空间目录内
- 防止路径遍历和越权访问

### 2. 用户白名单
```json
{
  "channels": {
    "telegram": {
      "allowFrom": ["user_id1", "user_id2"]
    }
  }
}
```
- 只允许指定用户与 AI 交互
- 防止未授权访问

## 💾 配置文件位置

- **配置**: `~/.nanobot/config.json`
- **工作空间**: `~/.nanobot/workspace/`
- **数据**: `~/.nanobot/data/`
  - Cron 任务: `data/cron/jobs.json`

## 🌟 扩展能力

### 自定义技能
在工作空间的 `skills/` 目录下创建技能：

```
workspace/
└── skills/
    └── my-skill/
        └── SKILL.md  # 技能说明
```

### 自定义工具
继承 `Tool` 基类并注册到 `ToolRegistry`：

```python
from nanobot.agent.tools.base import Tool

class MyTool(Tool):
    @property
    def name(self) -> str:
        return "my_tool"
    
    @property
    def description(self) -> str:
        return "我的自定义工具"
    
    @property
    def parameters(self) -> dict:
        return {
            "type": "object",
            "properties": {
                "param": {"type": "string", "description": "参数"}
            }
        }
    
    async def execute(self, **kwargs) -> str:
        return "执行结果"
```

## 🚀 快速开始

1. **安装**
```bash
pip install nanobot-ai
```

2. **初始化**
```bash
nanobot onboard
```

3. **配置 API Key**
编辑 `~/.nanobot/config.json`，添加 API Key

4. **运行**
```bash
nanobot agent -m "Hello!"
```

## 📚 相关文档

- [02-CLI命令系统.md](./02-CLI命令系统.md) - CLI 命令详解
- [03-配置系统.md](./03-配置系统.md) - 配置系统详解
- [04-Agent核心.md](./04-Agent核心.md) - Agent 核心逻辑
- [05-上下文构建.md](./05-上下文构建.md) - 上下文构建详解
- [06-记忆系统.md](./06-记忆系统.md) - 记忆系统详解
- [07-工具系统.md](./07-工具系统.md) - 工具系统详解
- [其他文档...](./)

## 🤝 贡献指南

项目代码简洁清晰，适合学习和贡献：
- 核心代码仅 4,000 行
- 模块化设计，易于扩展
- 完整的类型注解
- 详细的文档字符串

## 📄 许可证

MIT License - 适用于教育、研究和技术交流